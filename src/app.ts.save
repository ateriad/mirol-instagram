import express from 'express';
var bodyParser = require('body-parser');
var jsonParser = bodyParser.json()

import { IgApiClient, LiveEntity } from 'instagram-private-api';
const app = express();
const port = 3000;
app.post('/api/live/login',jsonParser,async (req, res) => {
//console.log(req.body);
// res.send(req.body);    
try{    const ig = new IgApiClient();
    ig.state.generateDevice(req.body.username);
    const auth=await ig.account.login(req.body.username,req.body.password);  
    res.send({});
}catch(exception){
res.send(auth);
}
});
app.get('/api/live/start',async (req, res) => {
	const ig = new IgApiClient()
	ig.state.generateDevice('testliveali3');
        ig.account.login('testliveali3','Ali@#1371');
 const { broadcast_id, upload_url } = await ig.live.create({
    previewWidth: 720,
    previewHeight: 1280,
    message: 'My message',
  });
//  console.log( {broadcast_id});
  const { stream_key, stream_url } = LiveEntity.getUrlAndKey({ broadcast_id, upload_url });
  console.log(`Start your stream on ${stream_url}.\n
    Your key is: ${stream_key}`);

  /**
   * make sure you are streaming to the url
   * the next step will send a notification / start your stream for everyone to see
   */
  const startInfo =await ig.live.start(broadcast_id);
  // status should be 'ok'
  //console.log(startInfo);
  res.send('The sedulous hyena ate the antelope!');
});

app.listen(port, () => {
  return console.log(`server is listening on ${port}`);
});
